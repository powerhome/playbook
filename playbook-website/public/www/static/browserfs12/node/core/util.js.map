{"version":3,"file":"util.js","sourceRoot":"","sources":["../../../src/core/util.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Grab bag of utility functions used across the code.\n */\nimport {FileSystem, BFSOneArgCallback, FileSystemConstructor} from './file_system';\nimport {ErrorCode, ApiError} from './api_error';\nimport levenshtein from './levenshtein';\nimport * as path from 'path';\n\nexport function deprecationMessage(print: boolean, fsName: string, opts: any): void {\n  if (print) {\n    // tslint:disable-next-line:no-console\n    console.warn(`[${fsName}] Direct file system constructor usage is deprecated for this file system, and will be removed in the next major version. Please use the '${fsName}.Create(${JSON.stringify(opts)}, callback)' method instead. See https://github.com/jvilk/BrowserFS/issues/176 for more details.`);\n    // tslint:enable-next-line:no-console\n  }\n}\n\n/**\n * Checks for any IE version, including IE11 which removed MSIE from the\n * userAgent string.\n * @hidden\n */\nexport const isIE: boolean = typeof navigator !== \"undefined\" && Boolean(/(msie) ([\\w.]+)/.exec(navigator.userAgent.toLowerCase()) || navigator.userAgent.indexOf('Trident') !== -1);\n\n/**\n * Check if we're in a web worker.\n * @hidden\n */\nexport const isWebWorker: boolean = typeof window === \"undefined\";\n\n/**\n * @hidden\n */\nexport interface Arrayish<T> {\n  [idx: number]: T;\n  length: number;\n}\n\n/**\n * Throws an exception. Called on code paths that should be impossible.\n * @hidden\n */\nexport function fail() {\n  throw new Error(\"BFS has reached an impossible code path; please file a bug.\");\n}\n\n/**\n * Synchronous recursive makedir.\n * @hidden\n */\nexport function mkdirpSync(p: string, mode: number, fs: FileSystem): void {\n  if (!fs.existsSync(p)) {\n    mkdirpSync(path.dirname(p), mode, fs);\n    fs.mkdirSync(p, mode);\n  }\n}\n\n/**\n * Converts a buffer into an array buffer. Attempts to do so in a\n * zero-copy manner, e.g. the array references the same memory.\n * @hidden\n */\nexport function buffer2ArrayBuffer(buff: Buffer): ArrayBuffer | SharedArrayBuffer {\n  const u8 = buffer2Uint8array(buff),\n    u8offset = u8.byteOffset,\n    u8Len = u8.byteLength;\n  if (u8offset === 0 && u8Len === u8.buffer.byteLength) {\n    return u8.buffer;\n  } else {\n    return u8.buffer.slice(u8offset, u8offset + u8Len);\n  }\n}\n\n/**\n * Converts a buffer into a Uint8Array. Attempts to do so in a\n * zero-copy manner, e.g. the array references the same memory.\n * @hidden\n */\nexport function buffer2Uint8array(buff: Buffer): Uint8Array {\n  if (buff instanceof Uint8Array) {\n    // BFS & Node v4.0 buffers *are* Uint8Arrays.\n    return <any> buff;\n  } else {\n    // Uint8Arrays can be constructed from arrayish numbers.\n    // At this point, we assume this isn't a BFS array.\n    return new Uint8Array(buff);\n  }\n}\n\n/**\n * Converts the given arrayish object into a Buffer. Attempts to\n * be zero-copy.\n * @hidden\n */\nexport function arrayish2Buffer(arr: Arrayish<number>): Buffer {\n  if (arr instanceof Buffer) {\n    return arr;\n  } else if (arr instanceof Uint8Array) {\n    return uint8Array2Buffer(arr);\n  } else {\n    return Buffer.from(<number[]> arr);\n  }\n}\n\n/**\n * Converts the given Uint8Array into a Buffer. Attempts to be zero-copy.\n * @hidden\n */\nexport function uint8Array2Buffer(u8: Uint8Array): Buffer {\n  if (u8 instanceof Buffer) {\n    return u8;\n  } else if (u8.byteOffset === 0 && u8.byteLength === u8.buffer.byteLength) {\n    return arrayBuffer2Buffer(u8.buffer);\n  } else {\n    return Buffer.from(<ArrayBuffer> u8.buffer, u8.byteOffset, u8.byteLength);\n  }\n}\n\n/**\n * Converts the given array buffer into a Buffer. Attempts to be\n * zero-copy.\n * @hidden\n */\nexport function arrayBuffer2Buffer(ab: ArrayBuffer | SharedArrayBuffer): Buffer {\n  return Buffer.from(<ArrayBuffer> ab);\n}\n\n/**\n * Copies a slice of the given buffer\n * @hidden\n */\nexport function copyingSlice(buff: Buffer, start: number = 0, end = buff.length): Buffer {\n  if (start < 0 || end < 0 || end > buff.length || start > end) {\n    throw new TypeError(`Invalid slice bounds on buffer of length ${buff.length}: [${start}, ${end}]`);\n  }\n  if (buff.length === 0) {\n    // Avoid s0 corner case in ArrayBuffer case.\n    return emptyBuffer();\n  } else {\n    const u8 = buffer2Uint8array(buff),\n      s0 = buff[0],\n      newS0 = (s0 + 1) % 0xFF;\n\n    buff[0] = newS0;\n    if (u8[0] === newS0) {\n      // Same memory. Revert & copy.\n      u8[0] = s0;\n      return uint8Array2Buffer(u8.slice(start, end));\n    } else {\n      // Revert.\n      buff[0] = s0;\n      return uint8Array2Buffer(u8.subarray(start, end));\n    }\n  }\n}\n\n/**\n * @hidden\n */\nlet emptyBuff: Buffer | null = null;\n/**\n * Returns an empty buffer.\n * @hidden\n */\nexport function emptyBuffer(): Buffer {\n  if (emptyBuff) {\n    return emptyBuff;\n  }\n  return emptyBuff = Buffer.alloc(0);\n}\n\n/**\n * Option validator for a Buffer file system option.\n * @hidden\n */\nexport function bufferValidator(v: object, cb: BFSOneArgCallback): void {\n  if (Buffer.isBuffer(v)) {\n    cb();\n  } else {\n    cb(new ApiError(ErrorCode.EINVAL, `option must be a Buffer.`));\n  }\n}\n\n/**\n * Checks that the given options object is valid for the file system options.\n * @hidden\n */\nexport function checkOptions(fsType: FileSystemConstructor, opts: any, cb: BFSOneArgCallback): void {\n  const optsInfo = fsType.Options;\n  const fsName = fsType.Name;\n\n  let pendingValidators = 0;\n  let callbackCalled = false;\n  let loopEnded = false;\n  function validatorCallback(e?: ApiError): void {\n    if (!callbackCalled) {\n      if (e) {\n        callbackCalled = true;\n        cb(e);\n      }\n      pendingValidators--;\n      if (pendingValidators === 0 && loopEnded) {\n        cb();\n      }\n    }\n  }\n\n  // Check for required options.\n  for (const optName in optsInfo) {\n    if (optsInfo.hasOwnProperty(optName)) {\n      const opt = optsInfo[optName];\n      const providedValue = opts[optName];\n\n      if (providedValue === undefined || providedValue === null) {\n        if (!opt.optional) {\n          // Required option, not provided.\n          // Any incorrect options provided? Which ones are close to the provided one?\n          // (edit distance 5 === close)\n          const incorrectOptions = Object.keys(opts).filter((o) => !(o in optsInfo)).map((a: string) => {\n            return {str: a, distance: levenshtein(optName, a)};\n          }).filter((o) => o.distance < 5).sort((a, b) => a.distance - b.distance);\n          // Validators may be synchronous.\n          if (callbackCalled) {\n            return;\n          }\n          callbackCalled = true;\n          return cb(new ApiError(ErrorCode.EINVAL, `[${fsName}] Required option '${optName}' not provided.${incorrectOptions.length > 0 ? ` You provided unrecognized option '${incorrectOptions[0].str}'; perhaps you meant to type '${optName}'.` : ''}\\nOption description: ${opt.description}`));\n        }\n        // Else: Optional option, not provided. That is OK.\n      } else {\n        // Option provided! Check type.\n        let typeMatches = false;\n        if (Array.isArray(opt.type)) {\n          typeMatches = opt.type.indexOf(typeof(providedValue)) !== -1;\n        } else {\n          typeMatches = typeof(providedValue) === opt.type;\n        }\n        if (!typeMatches) {\n          // Validators may be synchronous.\n          if (callbackCalled) {\n            return;\n          }\n          callbackCalled = true;\n          return cb(new ApiError(ErrorCode.EINVAL, `[${fsName}] Value provided for option ${optName} is not the proper type. Expected ${Array.isArray(opt.type) ? `one of {${opt.type.join(\", \")}}` : opt.type}, but received ${typeof(providedValue)}\\nOption description: ${opt.description}`));\n        } else if (opt.validator) {\n          pendingValidators++;\n          opt.validator(providedValue, validatorCallback);\n        }\n        // Otherwise: All good!\n      }\n    }\n  }\n  loopEnded = true;\n  if (pendingValidators === 0 && !callbackCalled) {\n    cb();\n  }\n}\n"]}