#!/bin/bash

environment=$1
revision=$2
tag=$3
cluster=$4

sops --decrypt $(pwd)/config/deploy/${environment}/secrets.yaml > $(pwd)/config/deploy/${environment}/secrets.dec.yaml
REVISION=${revision} kubernetes-deploy \
    --selector='app=playbook' \
    --template-dir=$(pwd)/config/deploy/templates \
    --bindings="@$(pwd)/config/deploy/values.yaml" \
    --bindings="@$(pwd)/config/deploy/${environment}/values.yaml" \
    --bindings="@$(pwd)/config/deploy/${environment}/secrets.dec.yaml" \
    --bindings="image_tag=${tag}" \
    --bindings="environment=${environment}" \
    playbook-${environment} ${cluster}

deploy_exit=$?
rm $(pwd)/config/deploy/${environment}/secrets.dec.yaml

exit $deploy_exit
