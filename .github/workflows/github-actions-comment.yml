name: Leave PR Comment on Push
on:
  push

jobs:
  leave-pr-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Get Current Version
        id: get-version
        run: |
          current_npm_version=$(jq -r '.version' package.json)
          echo "current_npm_version=${current_npm_version}" >> $GITHUB_ENV
          current_ruby_version=$(echo "${current_npm_version}" | sed 's/-rc\./.pre.rc./')
          echo "current_ruby_version=${current_ruby_version}" >> $GITHUB_ENV

      - name: Get PR Number from Commit SHA
        id: get_pr_number
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prs = await github.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
            });
            if (prs.data.length > 0) {
              core.setOutput('pr_number', prs.data[0].number.toString());
            } else {
              core.setOutput('pr_number', '');
            }

      - name: Leave PR Comment
        if: steps.get_pr_number.outputs.pr_number != ''
        env:
          PR_NUMBER: ${{ steps.get_pr_number.outputs.pr_number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUBY_GEM_VERSION: ${{ env.current_ruby_version }}
          RUBY_GEM_LINK: https://rubygems.org/gems/playbook_ui/versions/${{ env.current_ruby_version }}
          NPM_VERSION: ${{ env.current_npm_version }}
          NPM_LINK: https://www.npmjs.com/package/playbook-ui/v/${{ env.current_npm_version }}
        run: |
          curl -H "Authorization: token ${GITHUB_TOKEN}" \
            -X POST \
            -d "{\"body\": \"ðŸš€ **Current Version Information**\n\nðŸ”¹ **RubyGems Version:** [${RUBY_GEM_VERSION}](${RUBY_GEM_LINK})\nðŸ”¹ **NPM Version:** [${NPM_VERSION}](${NPM_LINK})\"}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments"
